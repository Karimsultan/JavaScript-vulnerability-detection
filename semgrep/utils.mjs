import { extractRegexesFromSource } from "./findRegex.mjs";
import safe from "safe-regex";
import fs from "fs";
import { spawnSync } from "child_process";

export function semgrep(func, ruleFile) {
    fs.writeFileSync("temp.js", func);
    const semgrep = spawnSync("semgrep", [`--config=${ruleFile}`, "./temp.js"]);
    fs.rmSync("temp.js");

    const result = semgrep.stdout.toString();
    const err = semgrep.stderr.toString();
    if (!result) {
        console.log(err);
    }
    return !!result;
}

export function evilRegExes(func) {
    try{
        const iterator = extractRegexesFromSource("const name = " + func, null);
        const arr = Array.from(iterator).map(regex => regex.pattern);
        
        return arr.filter(el => !safe(el));
    } catch(e) {
        console.error(e);
        return [];
    }
}