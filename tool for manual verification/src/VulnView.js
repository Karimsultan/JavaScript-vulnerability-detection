import { Tab, Tabs } from "@material-ui/core";
import { useEffect } from "react";
import { useLayoutEffect } from "react";
import { useState } from "react";
import { FileView } from "./FileView";
import { functionsSorted, useForceUpdate } from "./utils";
import { VulnStats } from "./VulnStats";

export function VulnView({vulnerability, onChange}) {
    const [fileIndex, setFileIndex] = useState(0);
    useLayoutEffect(() => setFileIndex(0), [vulnerability]);
    const selectedFile = vulnerability.files[fileIndex];
    const forceUpdate = useForceUpdate();

    function handleChange(event, val) {
        setFileIndex(val);
    }
    function handleStatusChange() {
        forceUpdate();
        onChange?.();
    }

    return <>
        <VulnStats vuln={vulnerability}></VulnStats>
        <Tabs value={fileIndex} onChange={handleChange} aria-label="simple tabs" variant="scrollable" scrollButtons="auto">
            {vulnerability.files.map((file, i) => 
                <Tab
                    label={`${file.link.split("/").slice(-1)[0]} ${functionsSorted(file) ? "(âœ”)" : ""}`}
                    key={file.link}></Tab>
            )}
        </Tabs>
        {selectedFile && <FileView file={selectedFile} onChange={handleStatusChange}></FileView>}
    </>;
}