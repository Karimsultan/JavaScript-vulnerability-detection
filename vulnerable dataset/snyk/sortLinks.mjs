import fs from "fs";
import path from 'path';
import { fileURLToPath } from 'url'

const linkFilters = [
    {test: /commit/i, category: "Commit"},
    {test: /vulnerable/i, category: "Vulnerable code"},
    {test: /issue/i, category: "Issue"},
    {test: /((.*\s)?PR(\s.*)?)|(pull request)/i, category: "Pull request"},
    {test: /advisory/i, category: "Advisory"},
    {test: /report|bug/i, category: "Bug report"},
    {test: /./, category: "Other"}
]

export function categorizeLinks(db) {
    const linksByType = db.reduce((acc, vuln) =>
        {
            const filter = linkFilters
                .find(({test}) => vuln.linksAndNames.some(({name}) => name.match(test)));
            const match = vuln.linksAndNames
                .find(({name}) => name.match(filter.test));

            acc[filter.category] = acc[filter.category] || [];

            const {linksAndNames, ...vulnInfo} = vuln;
            acc[filter.category].push({...match, ...vulnInfo});
            return acc;
        }, {}
    )

    const sorted = Object.entries(linksByType)
        .map(([key, links]) => [key, links.length])
        .sort((a,b) => b[1]-a[1]);

    console.log(sorted)
    return linksByType;
}

function isCLI() {
    const nodePath = path.resolve(process.argv[1]);
    const modulePath = path.resolve(fileURLToPath(import.meta.url));
    return nodePath === modulePath;
}

if (isCLI()) {
    const db = JSON.parse(fs.readFileSync("linksDB2.json", "utf-8"))
    const linksByType = categorizeLinks(db);
    console.log(linksByType);
    fs.writeFileSync("./sortedLinks2.json", JSON.stringify(linksByType));
}